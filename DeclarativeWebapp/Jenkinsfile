pipeline {
    agent any

    tools {
        maven 'Maven_3.8.6'
        jdk 'JDK_17'
    }

    environment {
        CATALINA_HOME = 'D:\\DevopsTaining\\All softwares\\apache-tomcat-9.0.104\\apache-tomcat-9.0.104'
    }

    stages {
        stage('Build WAR') {
            steps {
                dir('DeclarativeWebapp') {
                    bat 'mvn clean package'
                }
            }
        }

        stage('Deploy WAR') {
            steps {
                dir('DeclarativeWebapp') {
                    bat 'copy target\\DeclarativeWebapp.war "%CATALINA_HOME%\\webapps\\"'
                }
            }
        }

        stage('Restart Tomcat') {
            steps {
                bat 'cmd /c "%CATALINA_HOME%\\bin\\shutdown.bat" || echo Tomcat was not running'
                bat 'ping -n 5 127.0.0.1 > nul'
                bat 'cmd /c "%CATALINA_HOME%\\bin\\startup.bat"'
                bat 'ping -n 10 127.0.0.1 > nul'
                bat 'netstat -ano | findstr :8045'
                bat 'type "%CATALINA_HOME%\\logs\\catalina.out" || echo catalina.out not found'
            }
        }
    }
}
